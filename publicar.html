<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Publicar Item ‚Äî Achados & Perdidos Angola</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: radial-gradient(circle at top left, #0a192f, #112240, #0a192f);
      background-size: 200% 200%;
      animation: movimento 10s ease infinite;
      color: #e6f0ff;
    }
    @keyframes movimento {
      0% { background-position: 0% 0%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 0%; }
    }
    header {
      backdrop-filter: blur(6px);
      background: rgba(10,25,47,0.85);
      transition: 0.4s;
    }
    header.scrolled {
      background: rgba(10,25,47,0.95);
    }
    .card {
      background: rgba(255,255,255,0.06);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 12px;
    }
  </style>
</head>
<body>
  <header class="text-white p-4 fixed w-full top-0 left-0 z-40">
    <div class="max-w-6xl mx-auto flex items-center justify-between">
      <a href="index.html" class="flex items-center gap-2 font-bold text-xl">
        <i data-lucide="search" class="w-6 h-6"></i> Achados & Perdidos
      </a>
      <nav class="flex items-center gap-6 text-sm font-medium">
        <a href="index.html" class="hover:underline">üè† In√≠cio</a>
        <a href="feed.html" class="hover:underline">üì∞ Feed</a>
      </nav>
    </div>
  </header>

  <main class="max-w-3xl mx-auto p-6 mt-28">
    <div class="card p-6">
      <h1 class="text-2xl font-bold mb-4 text-blue-100">Publicar Item</h1>
      <form id="form-publicar" class="space-y-4">
        <input id="titulo" type="text" placeholder="T√≠tulo" class="w-full p-3 rounded border dark:bg-gray-700" required />
        <textarea id="descricao" rows="3" placeholder="Descri√ß√£o (opcional)" class="w-full p-3 rounded border dark:bg-gray-700"></textarea>
        <div class="grid sm:grid-cols-2 gap-3">
          <select id="tipo" class="p-3 rounded border dark:bg-gray-700">
            <option value="perdido">Perdido</option>
            <option value="encontrado">Encontrado</option>
          </select>
          <select id="categoria" class="p-3 rounded border dark:bg-gray-700">
            <option>Documentos</option>
            <option>Carteira</option>
            <option>Telem√≥vel</option>
            <option>Chaves</option>
            <option>Outros</option>
          </select>
        </div>
        <input id="foto" type="file" accept="image/*" class="w-full p-3 rounded border dark:bg-gray-700" required />
        <input id="contacto" type="tel" placeholder="Contacto (WhatsApp)" class="w-full p-3 rounded border dark:bg-gray-700" required />
        <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded font-semibold hover:bg-blue-700">Publicar</button>
      </form>
    </div>
  </main>

  <footer class="navy text-white p-6 text-center mt-8">
    ¬© <span id="ano"></span> Achados & Perdidos Angola
  </footer>

  <script type="module">
    (async () => {
      try {
        const [{ initializeApp }, { getFirestore, addDoc, collection, serverTimestamp }, { getAuth, onAuthStateChanged }, lucideModule] = await Promise.all([
          import('https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js'),
          import('https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js'),
          import('https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js'),
          import('https://unpkg.com/lucide@latest')
        ]);

        const firebaseCfg = await import('./firebase-config.js').catch(() => {
          throw new Error('‚ùå Ficheiro firebase-config.js n√£o encontrado ou inv√°lido.');
        });

        const app = initializeApp(firebaseCfg.firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const form = document.getElementById('form-publicar');
        const cloudName = 'dyylw9hjm';
        const uploadPreset = 'ml_default';

        let userLogado = null;

        // Verifica se o utilizador est√° logado
        onAuthStateChanged(auth, (user) => {
          userLogado = user;
          if (!user) {
            Swal.fire({
              icon: 'warning',
              title: 'Sess√£o necess√°ria',
              html: '<p>√â necess√°rio iniciar sess√£o para publicar.</p><br><button id="ir-login" class="swal2-confirm swal2-styled" style="background:#0a192f">üîë Ir para Login</button>',
              showConfirmButton: false,
              didOpen: () => {
                document.getElementById('ir-login').addEventListener('click', () => {
                  Swal.close();
                  window.location.href = 'index.html#login';
                });
              }
            });
          }
        });

        // Publicar item
        form.addEventListener('submit', async (e) => {
          e.preventDefault();

          if (!userLogado) {
            Swal.fire('‚ö†Ô∏è', 'Inicie sess√£o antes de publicar.', 'warning');
            return;
          }

          const titulo = document.getElementById('titulo').value.trim();
          const descricao = document.getElementById('descricao').value.trim();
          const tipo = document.getElementById('tipo').value;
          const categoria = document.getElementById('categoria').value;
          const contacto = document.getElementById('contacto').value.trim();
          const foto = document.getElementById('foto').files[0];

          if (!foto) {
            Swal.fire('‚ö†Ô∏è', 'Selecione uma imagem para o item.', 'warning');
            return;
          }

          Swal.fire({
            title: 'A publicar...',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
          });

          try {
            // Upload imagem Cloudinary
            const fd = new FormData();
            fd.append('file', foto);
            fd.append('upload_preset', uploadPreset);
            const upload = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
              method: 'POST',
              body: fd
            });

            if (!upload.ok) throw new Error('Erro ao fazer upload da imagem.');
            const img = await upload.json();

            // Gravar item no Firestore
            await addDoc(collection(db, 'items'), {
              uid: userLogado.uid,
              titulo,
              descricao,
              tipo,
              categoria,
              contacto,
              fotoURL: img.secure_url,
              created_at: serverTimestamp()
            });

            Swal.fire('‚úÖ', 'Item publicado com sucesso!', 'success');
            form.reset();
            setTimeout(() => location.href = 'feed.html', 1200);

          } catch (err) {
            console.error(err);
            Swal.fire('‚ùå Erro', err.message || 'Erro ao publicar o item.', 'error');
          }
        });

        if (lucideModule && lucideModule.createIcons) lucideModule.createIcons();
        document.getElementById('ano').textContent = new Date().getFullYear();

      } catch (err) {
        console.error(err);
        Swal.fire('‚ùå Erro ao iniciar p√°gina', err.message || String(err), 'error');
      }
    })();
  </script>
</body>
</html>
