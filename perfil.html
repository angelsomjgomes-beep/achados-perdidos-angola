<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Perfil ‚Äî Achados & Perdidos Angola</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: radial-gradient(circle at top left, #0a192f, #112240, #0a192f);
      color: #e6f0ff;
      min-height: 100vh;
    }
    .card {
      background: rgba(255,255,255,0.06);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 16px;
      padding: 1.5rem;
    }
  </style>
</head>
<body>
  <header class="text-white p-4 fixed w-full top-0 left-0 z-40 backdrop-blur-md bg-[rgba(10,25,47,0.85)]">
    <div class="max-w-6xl mx-auto flex items-center justify-between">
      <a href="index.html" class="flex items-center gap-2 font-bold text-xl">
        <i data-lucide="user" class="w-6 h-6"></i> Meu Perfil
      </a>
      <nav class="flex items-center gap-6 text-sm font-medium">
        <a href="feed.html" class="hover:underline">üì∞ Feed</a>
        <a href="publicar.html" class="hover:underline">‚ûï Publicar</a>
        <a href="index.html" class="hover:underline text-gray-300">üè† In√≠cio</a>
      </nav>
    </div>
  </header>

  <main class="max-w-4xl mx-auto mt-28 p-6 space-y-6">
    <!-- Perfil -->
    <div id="perfil-card" class="card text-center">
      <img id="foto-perfil" src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="Avatar" class="w-24 h-24 rounded-full mx-auto mb-4 border-2 border-blue-500">
      <h2 id="nome" class="text-xl font-bold">Carregando...</h2>
      <p id="email" class="text-sm text-gray-300 mb-3">---</p>

      <div class="space-y-2 text-sm text-gray-400 mb-4">
        <p><b>üìç Localiza√ß√£o:</b> <span id="localizacao">N√£o informada</span></p>
        <p><b>üéÇ Idade:</b> <span id="idade">N√£o informada</span></p>
      </div>

      <button id="btn-editar" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded font-semibold text-white">‚úèÔ∏è Editar Perfil</button>
      <button id="btn-sair" class="mt-3 bg-red-600 hover:bg-red-700 px-4 py-2 rounded font-semibold text-white">Sair</button>
    </div>

    <!-- Meus Artigos -->
    <div class="card">
      <h3 class="text-lg font-bold mb-3 text-blue-300">üì¶ Meus Artigos Publicados</h3>
      <div id="meus-artigos" class="space-y-3"></div>
    </div>
  </main>

  <footer class="text-center text-gray-400 text-sm mt-12 p-4">
    ¬© <span id="ano"></span> Achados & Perdidos Angola
  </footer>

  <script type="module">
    (async () => {
      try {
        const [{ initializeApp }, { getFirestore, collection, query, where, getDocs, doc, setDoc, getDoc }, { getAuth, onAuthStateChanged, signOut }, lucideModule] = await Promise.all([
          import('https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js'),
          import('https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js'),
          import('https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js'),
          import('https://unpkg.com/lucide@latest')
        ]);

        const firebaseCfg = await import('./firebase-config.js').catch(() => {
          throw new Error('‚ùå Ficheiro firebase-config.js n√£o encontrado ou inv√°lido.');
        });

        const app = initializeApp(firebaseCfg.firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const nomeEl = document.getElementById('nome');
        const emailEl = document.getElementById('email');
        const artigosEl = document.getElementById('meus-artigos');
        const btnSair = document.getElementById('btn-sair');
        const btnEditar = document.getElementById('btn-editar');
        const locEl = document.getElementById('localizacao');
        const idadeEl = document.getElementById('idade');
        const fotoEl = document.getElementById('foto-perfil');

        onAuthStateChanged(auth, async (user) => {
          if (!user) {
            Swal.fire({
              icon: 'warning',
              title: 'Sess√£o encerrada',
              text: 'Por favor, fa√ßa login para acessar o perfil.',
              confirmButtonText: 'Ir para Login'
            }).then(() => (window.location.href = 'login.html'));
            return;
          }

          // Dados b√°sicos
          nomeEl.textContent = user.displayName || 'Utilizador sem nome';
          emailEl.textContent = user.email || 'Sem email';
          fotoEl.src = user.photoURL || 'https://cdn-icons-png.flaticon.com/512/847/847969.png';

          // Buscar dados adicionais
          const userRef = doc(db, 'users', user.uid);
          const userSnap = await getDoc(userRef);
          if (userSnap.exists()) {
            const data = userSnap.data();
            locEl.textContent = data.localizacao || 'N√£o informada';
            idadeEl.textContent = data.idade || 'N√£o informada';
          }

          // Buscar artigos publicados
          const q = query(collection(db, 'items'), where('uid', '==', user.uid));
          const snap = await getDocs(q);
          if (snap.empty) {
            artigosEl.innerHTML = '<p class="text-gray-400 text-center">Nenhum artigo publicado ainda.</p>';
          } else {
            artigosEl.innerHTML = '';
            snap.forEach((doc) => {
              const d = doc.data();
              const card = document.createElement('div');
              card.className = 'bg-[rgba(255,255,255,0.05)] p-3 rounded-md border border-[rgba(255,255,255,0.08)]';
              card.innerHTML = `
                <div class="flex items-center gap-3">
                  <img src="${d.fotoURL || 'https://cdn-icons-png.flaticon.com/512/151/151970.png'}" class="w-16 h-16 rounded object-cover">
                  <div>
                    <h4 class="font-semibold text-blue-200">${d.titulo}</h4>
                    <p class="text-gray-400 text-sm">${d.categoria} ‚Äî ${d.tipo}</p>
                    <p class="text-gray-500 text-xs">${new Date(d.created_at?.seconds * 1000 || Date.now()).toLocaleDateString()}</p>
                  </div>
                </div>
              `;
              artigosEl.appendChild(card);
            });
          }

          // Editar perfil
          btnEditar.addEventListener('click', async () => {
            const { value: formValues } = await Swal.fire({
              title: 'Editar Perfil',
              html: `
                <input id="swal-nome" class="swal2-input" placeholder="Nome" value="${user.displayName || ''}">
                <input id="swal-local" class="swal2-input" placeholder="Localiza√ß√£o" value="${locEl.textContent || ''}">
                <input id="swal-idade" type="number" min="10" max="100" class="swal2-input" placeholder="Idade" value="${idadeEl.textContent || ''}">
              `,
              focusConfirm: false,
              preConfirm: () => ({
                nome: document.getElementById('swal-nome').value,
                localizacao: document.getElementById('swal-local').value,
                idade: document.getElementById('swal-idade').value
              }),
              confirmButtonText: 'üíæ Guardar',
              showCancelButton: true,
              cancelButtonText: 'Cancelar'
            });

            if (formValues) {
              await setDoc(userRef, formValues, { merge: true });
              Swal.fire('‚úÖ Guardado!', 'O perfil foi atualizado com sucesso.', 'success');
              locEl.textContent = formValues.localizacao || 'N√£o informada';
              idadeEl.textContent = formValues.idade || 'N√£o informada';
              nomeEl.textContent = formValues.nome || nomeEl.textContent;
            }
          });
        });

        // Sair da conta
        btnSair.addEventListener('click', async () => {
          await signOut(auth);
          Swal.fire('üëã', 'Sess√£o terminada com sucesso.', 'info');
          setTimeout(() => (window.location.href = 'index.html'), 1200);
        });

        if (lucideModule && lucideModule.createIcons) lucideModule.createIcons();
        document.getElementById('ano').textContent = new Date().getFullYear();

      } catch (err) {
        console.error(err);
        Swal.fire('‚ùå Erro ao carregar perfil', err.message || String(err), 'error');
      }
    })();
  </script>
</body>
</html>
