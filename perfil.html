<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Meu Perfil ‚Äî Achados & Perdidos Angola</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body { font-family: 'Inter', sans-serif; }
    .navy { background-color: #0a192f; }
    .navy-btn { background-color: #0a192f; }
    .navy-btn:hover { background-color: #112240; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-100 flex flex-col min-h-screen">

  <!-- Header -->
  <header class="navy text-white p-4 shadow dark:bg-gray-800">
    <div class="max-w-6xl mx-auto flex items-center justify-between">
      <a href="index.html" class="flex items-center gap-2 font-bold text-xl">
        <i data-lucide="search" class="w-6 h-6"></i> Achados & Perdidos
      </a>
      <nav class="flex items-center gap-6 text-sm font-medium">
        <a href="index.html" class="hover:underline">üè† In√≠cio</a>
        <a href="feed.html" class="hover:underline">üì∞ Feed</a>
        <a href="publicar.html" class="hover:underline">‚ûï Publicar</a>
        <a href="sobre.html" class="hover:underline">‚ÑπÔ∏è Sobre</a>
        <a href="perfil.html" class="underline font-semibold">üë§ Perfil</a>
      </nav>
    </div>
  </header>

  <!-- Conte√∫do -->
  <main class="flex-1 max-w-5xl mx-auto w-full p-6 space-y-6">
    <h1 class="text-3xl font-bold text-center text-blue-900 dark:text-blue-300">O Meu Perfil</h1>
    <p id="user-name" class="text-center text-gray-500 dark:text-gray-400"></p>

    <section id="lista" class="space-y-4 mt-6"></section>

    <div id="sem-itens" class="hidden text-center text-gray-500">
      Ainda n√£o publicaste nada üòî<br>
      <a href="publicar.html" class="underline text-blue-600">Publicar agora</a>
    </div>
  </main>

  <!-- Modal de Edi√ß√£o -->
  <div id="edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg w-96 p-6 space-y-4">
      <h2 class="text-xl font-semibold text-blue-900 dark:text-blue-300 text-center">Editar Publica√ß√£o</h2>
      <form id="edit-form" class="space-y-3">
        <input type="text" id="edit-titulo" class="w-full p-3 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="T√≠tulo" required />
        <textarea id="edit-descricao" class="w-full p-3 border rounded dark:bg-gray-700 dark:border-gray-600" placeholder="Descri√ß√£o"></textarea>
        <select id="edit-tipo" class="p-3 border rounded w-full dark:bg-gray-700 dark:border-gray-600">
          <option value="encontrado">Encontrado</option>
          <option value="perdido">Perdido</option>
        </select>
        <select id="edit-categoria" class="p-3 border rounded w-full dark:bg-gray-700 dark:border-gray-600">
          <option value="Carteira">Carteira</option>
          <option value="Telem√≥vel">Telem√≥vel</option>
          <option value="Documentos">Documentos</option>
          <option value="Chaves">Chaves</option>
          <option value="Outros">Outros</option>
        </select>
        <input type="file" id="edit-foto" accept="image/*" class="w-full p-3 border rounded dark:bg-gray-700 dark:border-gray-600" />
        <img id="edit-preview" class="hidden w-40 h-40 object-cover rounded-lg border mx-auto mt-2" />
        <div class="flex justify-between mt-4">
          <button type="button" id="cancelar-edicao" class="px-4 py-2 rounded bg-gray-400 hover:bg-gray-500 text-white">Cancelar</button>
          <button type="submit" class="px-4 py-2 rounded navy-btn text-white">Salvar</button>
        </div>
      </form>
    </div>
  </div>

  <footer class="navy text-white p-6 text-center dark:bg-gray-800 mt-8">
    ¬© <span id="ano"></span> Achados & Perdidos Angola
  </footer>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getFirestore, collection, query, where, orderBy, getDocs, deleteDoc, updateDoc, doc }
      from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { firebaseConfig } from "./firebase-config.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const lista = document.getElementById("lista");
    const semItens = document.getElementById("sem-itens");
    const nomeUser = document.getElementById("user-name");
    const editModal = document.getElementById("edit-modal");
    const editForm = document.getElementById("edit-form");
    const editTitulo = document.getElementById("edit-titulo");
    const editDescricao = document.getElementById("edit-descricao");
    const editTipo = document.getElementById("edit-tipo");
    const editCategoria = document.getElementById("edit-categoria");
    const editFoto = document.getElementById("edit-foto");
    const editPreview = document.getElementById("edit-preview");
    const cancelarBtn = document.getElementById("cancelar-edicao");

    let currentItemId = null;
    const cloudName = "dyylw9hjm";
    const uploadPreset = "ml_default";

    // Estado de login
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        Swal.fire({
          icon: 'warning',
          title: 'Aten√ß√£o!',
          text: 'Precisas de iniciar sess√£o para ver o perfil.',
          confirmButtonText: 'Ok'
        }).then(() => window.location.href = "index.html");
        return;
      }
      nomeUser.textContent = user.displayName || user.phoneNumber || "Utilizador";
      carregarItens(user.uid);
    });

    // Carregar os itens do utilizador
    async function carregarItens(uid) {
      lista.innerHTML = "";
      const q = query(collection(db, "items"), where("uid", "==", uid), orderBy("created_at", "desc"));
      const snap = await getDocs(q);
      if (snap.empty) {
        semItens.classList.remove("hidden");
        return;
      }
      snap.forEach((docSnap) => {
        const it = docSnap.data();
        const card = document.createElement("div");
        card.className = "bg-white dark:bg-gray-800 border dark:border-gray-700 rounded-lg shadow p-4";
        card.innerHTML = `
          <div class="flex justify-between items-center">
            <div>
              <h3 class="text-lg font-semibold">${it.titulo}</h3>
              <p class="text-sm text-gray-500 dark:text-gray-400">${it.categoria} ‚Ä¢ ${it.tipo}</p>
            </div>
            <div class="flex gap-2">
              <button class="editar px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm">Editar</button>
              <button class="apagar px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-sm">Eliminar</button>
            </div>
          </div>
          <p class="mt-2 text-sm">${it.descricao || ""}</p>
          ${it.fotoURL ? `<img src="${it.fotoURL}" class="mt-2 rounded w-full max-h-60 object-cover">` : ""}
        `;
        lista.appendChild(card);

        // Eliminar item
        card.querySelector(".apagar").addEventListener("click", async () => {
          const confirm = await Swal.fire({
            title: 'Eliminar item?',
            text: 'Esta a√ß√£o n√£o pode ser desfeita!',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Sim, eliminar',
            cancelButtonText: 'Cancelar',
            confirmButtonColor: '#d33',
          });
          if (confirm.isConfirmed) {
            await deleteDoc(doc(db, "items", docSnap.id));
            card.remove();
            Swal.fire('üóëÔ∏è Eliminado!', 'O item foi removido com sucesso.', 'success');
          }
        });

        // Editar item
        card.querySelector(".editar").addEventListener("click", () => abrirEdicao(docSnap.id, it));
      });
    }

    // Abrir modal de edi√ß√£o
    function abrirEdicao(id, item) {
      currentItemId = id;
      editTitulo.value = item.titulo;
      editDescricao.value = item.descricao || "";
      editTipo.value = item.tipo;
      editCategoria.value = item.categoria;
      if (item.fotoURL) {
        editPreview.src = item.fotoURL;
        editPreview.classList.remove("hidden");
      } else {
        editPreview.classList.add("hidden");
      }
      editModal.classList.remove("hidden");
    }

    cancelarBtn.addEventListener("click", () => {
      editModal.classList.add("hidden");
      currentItemId = null;
    });

    editFoto.addEventListener("change", () => {
      const file = editFoto.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = e => {
          editPreview.src = e.target.result;
          editPreview.classList.remove("hidden");
        };
        reader.readAsDataURL(file);
      }
    });

    // Salvar altera√ß√µes
    editForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentItemId) return;

      Swal.fire({ title: 'A guardar...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

      let novaFotoURL = editPreview.src;
      const file = editFoto.files[0];
      if (file) {
        const formData = new FormData();
        formData.append("file", file);
        formData.append("upload_preset", uploadPreset);
        const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
          method: "POST",
          body: formData
        });
        const data = await res.json();
        novaFotoURL = data.secure_url;
      }

      await updateDoc(doc(db, "items", currentItemId), {
        titulo: editTitulo.value,
        descricao: editDescricao.value,
        tipo: editTipo.value,
        categoria: editCategoria.value,
        fotoURL: novaFotoURL
      });

      Swal.fire('‚úÖ Atualizado!', 'A tua publica√ß√£o foi atualizada com sucesso.', 'success');
      editModal.classList.add("hidden");
      currentItemId = null;
      setTimeout(() => window.location.reload(), 1500);
    });

    document.getElementById("ano").textContent = new Date().getFullYear();
    lucide.createIcons();
  </script>
</body>
</html>
