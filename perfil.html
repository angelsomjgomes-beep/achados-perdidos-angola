<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Perfil ‚Äî Achados & Perdidos Angola</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: radial-gradient(circle at top left, #0a192f, #112240, #0a192f);
      color: #e6f0ff;
      min-height: 100vh;
    }
    .card {
      background: rgba(255,255,255,0.06);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 16px;
      padding: 1.5rem;
    }
    .banner {
      position: relative;
      background: linear-gradient(135deg, rgba(13,42,78,1), rgba(17,34,68,1));
      height: 130px;
      border-radius: 0 0 20px 20px;
      margin-top: 56px;
    }
    .avatar-container { position: relative; top: -48px; }
  </style>
</head>
<body>
  <!-- Navbar din√¢mica -->
  <header class="text-white p-4 fixed w-full top-0 left-0 z-40 backdrop-blur-md bg-[rgba(10,25,47,0.85)]">
    <div class="max-w-6xl mx-auto flex items-center justify-between">
      <a href="index.html" class="flex items-center gap-2 font-bold text-xl">
        <i data-lucide="search" class="w-6 h-6"></i> Achados & Perdidos
      </a>
      <nav class="flex items-center gap-6 text-sm font-medium">
        <a href="feed.html" class="hover:underline">üì∞ Feed</a>
        <a href="publicar.html" class="hover:underline">‚ûï Publicar</a>
        <a id="perfil-link" href="login.html" class="hover:underline text-blue-400">üîë Login</a>
      </nav>
    </div>
  </header>

  <!-- Banner visual -->
  <div class="banner"></div>

  <main class="max-w-4xl mx-auto p-6 space-y-6">
    <!-- Perfil -->
    <div id="perfil-card" class="card text-center -mt-16">
      <div class="avatar-container">
        <img id="foto-perfil" src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="Avatar" class="w-28 h-28 rounded-full mx-auto border-4 border-blue-500 shadow-lg object-cover bg-gray-800">
      </div>
      <h2 id="nome" class="text-2xl font-bold mt-2">Carregando...</h2>
      <p id="email" class="text-sm text-gray-300 mb-3">---</p>

      <div class="space-y-2 text-sm text-gray-400 mb-4">
        <p><b>üìç Localiza√ß√£o:</b> <span id="localizacao">N√£o informada</span></p>
        <p><b>üéÇ Idade:</b> <span id="idade">N√£o informada</span></p>
      </div>

      <div class="flex justify-center gap-3">
        <button id="btn-editar" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded font-semibold text-white">‚úèÔ∏è Editar Perfil</button>
        <button id="btn-sair" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded font-semibold text-white">Sair</button>
      </div>
    </div>

    <!-- Meus Artigos -->
    <div class="card">
      <h3 class="text-lg font-bold mb-3 text-blue-300">üì¶ Meus Artigos Publicados</h3>
      <div id="meus-artigos" class="space-y-3"></div>
    </div>
  </main>

  <footer class="text-center text-gray-400 text-sm mt-12 p-4">
    ¬© <span id="ano"></span> Achados & Perdidos Angola
  </footer>

  <script type="module">
    (async () => {
      try {
        // Imports (din√¢micos para capturar erros)
        const [
          { initializeApp },
          { getFirestore, collection, query, where, getDocs, doc, setDoc, getDoc, serverTimestamp },
          { getAuth, onAuthStateChanged, signOut, updateProfile },
          lucideModule
        ] = await Promise.all([
          import('https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js'),
          import('https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js'),
          import('https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js'),
          import('https://unpkg.com/lucide@latest')
        ]);

        const firebaseCfg = await import('./firebase-config.js').catch(() => null);
        if (!firebaseCfg) throw new Error('‚ùå O ficheiro firebase-config.js n√£o foi encontrado. Coloca-o na mesma pasta.');

        // Inicializar Firebase
        const app = initializeApp(firebaseCfg.firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Cloudinary (usa as credenciais combinadas que pediste)
        const cloudName = 'dyylw9hjm';
        const uploadPreset = 'ml_default';

        // Elements
        const nomeEl = document.getElementById('nome');
        const emailEl = document.getElementById('email');
        const locEl = document.getElementById('localizacao');
        const idadeEl = document.getElementById('idade');
        const fotoEl = document.getElementById('foto-perfil');
        const artigosEl = document.getElementById('meus-artigos');
        const btnEditar = document.getElementById('btn-editar');
        const btnSair = document.getElementById('btn-sair');
        const perfilLink = document.getElementById('perfil-link');

        let currentUser = null;

        // Atualiza ano no footer
        document.getElementById('ano').textContent = new Date().getFullYear();

        // Fun√ß√£o para carregar artigos do user
        async function carregarArtigos(uid) {
          artigosEl.innerHTML = '<p class="text-gray-400 text-center">A carregar artigos...</p>';
          try {
            const q = query(collection(db, 'items'), where('uid', '==', uid));
            const snap = await getDocs(q);
            if (snap.empty) {
              artigosEl.innerHTML = '<p class="text-gray-400 text-center">Nenhum artigo publicado ainda.</p>';
              return;
            }
            artigosEl.innerHTML = '';
            snap.forEach(d => {
              const data = d.data();
              const card = document.createElement('div');
              card.className = 'bg-[rgba(255,255,255,0.05)] p-3 rounded-md border border-[rgba(255,255,255,0.08)]';
              card.innerHTML = `
                <div class="flex items-center gap-3">
                  <img src="${data.fotoURL || 'https://cdn-icons-png.flaticon.com/512/151/151970.png'}" class="w-16 h-16 rounded object-cover">
                  <div>
                    <h4 class="font-semibold text-blue-200">${data.titulo}</h4>
                    <p class="text-gray-400 text-sm">${data.categoria} ‚Äî ${data.tipo}</p>
                    <p class="text-gray-500 text-xs">${new Date(data.created_at?.seconds * 1000 || Date.now()).toLocaleDateString()}</p>
                  </div>
                </div>
              `;
              artigosEl.appendChild(card);
            });
          } catch (e) {
            console.error('Erro ao carregar artigos:', e);
            artigosEl.innerHTML = '<p class="text-red-400 text-center">Erro ao carregar artigos.</p>';
          }
        }

        // Escuta do estado de autentica√ß√£o
        onAuthStateChanged(auth, async (user) => {
          if (!user) {
            // n√£o autenticado ‚Üí redireciona para login
            Swal.fire({
              icon: 'warning',
              title: 'Sess√£o necess√°ria',
              text: 'Fa√ßa login para acessar o seu perfil.',
              confirmButtonText: 'Ir para login'
            }).then(() => (window.location.href = 'login.html'));
            return;
          }

          currentUser = user;
          // Navbar: mostrar Perfil
          perfilLink.textContent = 'üë§ Perfil';
          perfilLink.href = 'perfil.html';

          // Preencher dados vis√≠veis
          nomeEl.textContent = user.displayName || 'Utilizador sem nome';
          emailEl.textContent = user.email || (user.phoneNumber || 'Sem email');
          fotoEl.src = user.photoURL || 'https://cdn-icons-png.flaticon.com/512/847/847969.png';

          // Puxar dados extras do Firestore users/{uid}
          const userRef = doc(db, 'users', user.uid);
          const userSnap = await getDoc(userRef);
          if (userSnap.exists()) {
            const data = userSnap.data();
            locEl.textContent = data.localizacao || 'N√£o informada';
            idadeEl.textContent = data.idade || 'N√£o informada';
          } else {
            locEl.textContent = 'N√£o informada';
            idadeEl.textContent = 'N√£o informada';
          }

          // Carregar artigos do utilizador
          carregarArtigos(user.uid);
        });

        // Editar perfil (abre modal SweetAlert com inputs e upload)
        btnEditar.addEventListener('click', async () => {
          try {
            const { value: formValues } = await Swal.fire({
              title: 'Editar Perfil',
              html: `
                <input id="swal-nome" class="swal2-input" placeholder="Nome" value="${currentUser?.displayName || ''}">
                <input id="swal-local" class="swal2-input" placeholder="Localiza√ß√£o" value="${locEl.textContent || ''}">
                <input id="swal-idade" type="number" min="10" max="120" class="swal2-input" placeholder="Idade" value="${idadeEl.textContent || ''}">
                <label class="block text-left text-xs text-gray-200 mt-2 mb-1">Alterar foto de perfil (opcional)</label>
                <input id="swal-avatar" type="file" accept="image/*" class="swal2-file" />
              `,
              focusConfirm: false,
              showCancelButton: true,
              confirmButtonText: 'üíæ Guardar',
              preConfirm: async () => {
                const nome = document.getElementById('swal-nome').value.trim();
                const local = document.getElementById('swal-local').value.trim();
                const idade = document.getElementById('swal-idade').value.trim();
                const arquivo = document.getElementById('swal-avatar').files[0];

                // valida√ß√µes simples
                if (nome.length > 100) throw new Error('Nome demasiado longo (max 100 caracteres).');
                if (idade && (isNaN(idade) || idade < 10 || idade > 120)) throw new Error('Idade inv√°lida.');

                // se houver arquivo, faz upload primeiro
                let fotoURL = null;
                if (arquivo) {
                  // upload Cloudinary
                  const fd = new FormData();
                  fd.append('file', arquivo);
                  fd.append('upload_preset', uploadPreset);
                  const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
                    method: 'POST',
                    body: fd
                  });
                  if (!res.ok) {
                    const txt = await res.text().catch(()=>null);
                    throw new Error('Erro no upload da imagem. ' + (txt || ''));
                  }
                  const j = await res.json();
                  fotoURL = j.secure_url;
                }

                return { nome, local, idade, fotoURL };
              }
            });

            if (!formValues) return; // cancelado

            // mostrar loading enquanto grava
            Swal.fire({ title: 'A gravar...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            // Atualizar Auth profile (se necess√°rio)
            const updates = {};
            if (formValues.nome) updates.displayName = formValues.nome;
            if (formValues.fotoURL) updates.photoURL = formValues.fotoURL;

            if (Object.keys(updates).length > 0) {
              try {
                await updateProfile(auth.currentUser, updates);
              } catch (e) {
                console.warn('N√£o foi poss√≠vel atualizar o perfil Auth:', e);
              }
            }

            // Atualizar Firestore users/{uid}
            const userRef = doc(db, 'users', currentUser.uid);
            const toSave = {
              localizacao: formValues.local || null,
              idade: formValues.idade || null,
              updated_at: serverTimestamp()
            };
            if (formValues.fotoURL) toSave.photoURL = formValues.fotoURL;
            if (formValues.nome) toSave.nome = formValues.nome;

            await setDoc(userRef, toSave, { merge: true });

            // Atualiza UI localmente
            nomeEl.textContent = formValues.nome || nomeEl.textContent;
            locEl.textContent = formValues.local || locEl.textContent;
            idadeEl.textContent = formValues.idade || idadeEl.textContent;
            if (formValues.fotoURL) fotoEl.src = formValues.fotoURL;

            Swal.fire('‚úÖ Guardado', 'Perfil atualizado com sucesso.', 'success');

          } catch (err) {
            console.error('Erro ao editar perfil:', err);
            Swal.fire('‚ùå Erro', (err && err.message) ? err.message : 'Erro ao atualizar perfil.', 'error');
          }
        });

        // Logout
        btnSair.addEventListener('click', async () => {
          try {
            await signOut(auth);
            Swal.fire('üëã', 'Sess√£o terminada com sucesso.', 'info');
            setTimeout(() => (window.location.href = 'index.html'), 1100);
          } catch (e) {
            console.error('Erro no logout:', e);
            Swal.fire('‚ùå Erro', 'N√£o foi poss√≠vel terminar sess√£o.', 'error');
          }
        });

        if (lucideModule && lucideModule.createIcons) lucideModule.createIcons();

      } catch (err) {
        console.error(err);
        Swal.fire('‚ùå Erro ao carregar perfil', err?.message || String(err), 'error');
      }
    })();
  </script>
</body>
</html>

